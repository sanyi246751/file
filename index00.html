<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>標案分箱工具 - 自動箱號版本</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  select, button, input { margin: 5px 5px 5px 0; padding: 5px; }
  .top-controls {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 15px;
    gap: 30px;
    width: 92%;
  }
  .label-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .label-group label {
    white-space: nowrap;
  }
  .container {
    display: flex;
    gap: 30px;
    margin-top: 20px;
    width: 92%;
  }
  .box { border: 1px solid #ccc; padding: 10px; width: 45%; min-height: 300px; }
  ul { list-style: none; padding-left: 0; }
  li { margin: 5px 0; padding: 4px; border-radius: 4px; }
  li:hover { cursor: pointer; background: #e0e0e0; }
  h3 { margin-top: 0; }
  #boxDetails {
    margin-top: 20px;
    border: 1px solid #aaa;
    padding: 10px;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
    background: #f9f9f9;
  }
</style>
</head>
<body>

<h2>標案分箱工具（自動編號）</h2>

<div class="top-controls">
  <div class="label-group">
    <label for="yearSelect">選擇年度：</label>
    <select id="yearSelect"></select>
  </div>
  <div class="label-group">
    <label for="boxSelect">選擇箱號：</label>
    <select id="boxSelect"></select>
    <button id="addBoxBtn">新增箱號</button>
    <button id="delBoxBtn">刪除箱號</button>
  </div>
</div>

<div class="container">
  <div class="box">
    <h3>年度標案名稱（點擊加入箱號）</h3>
    <ul id="projectList"></ul>
  </div>
  <div class="box">
    <h3>箱號內容（點擊退回年度標案）</h3>
    <ul id="boxContent"></ul>
  </div>
</div>

<div style="margin-top:20px;">
  <button id="exportBtn" style="padding:10px 15px;">匯出分箱結果</button>
  <button id="showBoxDetailsBtn" style="margin-left: 10px; padding:10px 15px;">列出箱號內容</button>
  <button id="printPreviewBtn" style="margin-left: 10px; padding:10px 15px;">列印預覽</button>
  <button id="printAllBtn" style="margin-left: 10px; padding:10px 15px;">全部列印</button>
  <button id="saveToSheetBtn" style="margin-left: 10px; padding:10px 15px;">存檔至 Google Sheets</button>
</div>

<div id="boxDetails"></div>
<iframe id="printFrame" style="display:none;"></iframe>

<script>
const sheetURL = "https://opensheet.vercel.app/1LI0r1gbH0Ao2b1O6GfuwQFaje55_G4v4rqZwHpkJmD0/標案資料";
const webAppURL = "https://script.google.com/macros/s/AKfycbw63c4akixbo2-yIRwgNGpOHjxSna_jg298B-n6ypNH3Nmc1xONQXc820Emsa5H0mto_Q/exec";

const yearSelect = document.getElementById("yearSelect");
const boxSelect = document.getElementById("boxSelect");
const projectList = document.getElementById("projectList");
const boxContent = document.getElementById("boxContent");
const addBoxBtn = document.getElementById("addBoxBtn");
const delBoxBtn = document.getElementById("delBoxBtn");
const exportBtn = document.getElementById("exportBtn");
const showBoxDetailsBtn = document.getElementById("showBoxDetailsBtn");
const printPreviewBtn = document.getElementById("printPreviewBtn");
const printAllBtn = document.getElementById("printAllBtn");
const saveToSheetBtn = document.getElementById("saveToSheetBtn");
const boxDetailsDiv = document.getElementById("boxDetails");
const printFrame = document.getElementById("printFrame");

const yearData = {};
const boxAssignments = {};

// 用 JSONP 讀取分箱結果，避免 CORS 問題
function loadSavedAssignments() {
  return new Promise((resolve, reject) => {
    const callbackName = "jsonpCallback_" + Date.now();
    window[callbackName] = function(data) {
      if (data.error) {
        reject(data.error);
        delete window[callbackName];
        script.remove();
        return;
      }
      data.forEach(({ box, project }) => {
        if (!boxAssignments[box]) boxAssignments[box] = [];
        boxAssignments[box].push(project);
      });
      delete window[callbackName];
      script.remove();
      resolve();
    };
    const script = document.createElement("script");
    script.src = webAppURL + "?callback=" + callbackName;
    script.onerror = () => {
      delete window[callbackName];
      script.remove();
      reject("讀取失敗");
    };
    document.body.appendChild(script);
  });
}

async function loadSheetData() {
  try {
    const res = await fetch(sheetURL);
    const raw = await res.json();

    // 解析年度與標案名稱
    Object.keys(raw[0] || {}).forEach(key => {
      const year = key.trim();
      if (/^\d{3,}年$/.test(year)) {
        yearData[year] = [];
      }
    });

    raw.forEach(row => {
      for (const key in row) {
        const year = key.trim();
        if (yearData[year] && row[key].trim() !== "") {
          yearData[year].push(row[key].trim());
        }
      }
    });

    // 預設每年建立三個箱號
    Object.keys(yearData).forEach(year => {
      for (let i = 1; i <= 3; i++) {
        const boxId = `${year}-${i}`;
        if (!boxAssignments[boxId]) boxAssignments[boxId] = [];
      }
    });

    // 年度下拉選單
    yearSelect.innerHTML = "";
    Object.keys(yearData).forEach(y => {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    });
    if (yearSelect.options.length > 0) yearSelect.value = yearSelect.options[0].value;

    refreshBoxSelect();
    updateProjectList();
    updateBoxContent();

    await loadSavedAssignments();

    updateProjectList();
    updateBoxContent();

  } catch (e) {
    alert("讀取標案資料失敗：" + e);
  }
}

function refreshBoxSelect() {
  const year = yearSelect.value;
  boxSelect.innerHTML = "";
  const boxes = Object.keys(boxAssignments)
    .filter(b => b.startsWith(year + "-"))
    .sort((a,b) => parseInt(a.split("-")[1]) - parseInt(b.split("-")[1]));

  boxes.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b;
    opt.textContent = b;
    boxSelect.appendChild(opt);
  });
  if (boxes.length > 0) boxSelect.value = boxes[0];
}

function updateProjectList() {
  const year = yearSelect.value;
  const projects = yearData[year] || [];

  // 排除已分配到箱號的標案
  let assignedProjects = [];
  Object.keys(boxAssignments).forEach(box => {
    assignedProjects = assignedProjects.concat(boxAssignments[box]);
  });

  projectList.innerHTML = "";
  projects.forEach(p => {
    if (!assignedProjects.includes(p)) {
      const li = document.createElement("li");
      li.textContent = p;
      projectList.appendChild(li);
    }
  });
}

function updateBoxContent() {
  const box = boxSelect.value;
  const projects = boxAssignments[box] || [];

  boxContent.innerHTML = "";
  projects.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p;
    boxContent.appendChild(li);
  });
}

yearSelect.addEventListener("change", () => {
  refreshBoxSelect();
  updateProjectList();
  updateBoxContent();
  boxDetailsDiv.textContent = "";
});

boxSelect.addEventListener("change", () => {
  updateBoxContent();
  boxDetailsDiv.textContent = "";
});

projectList.addEventListener("click", e => {
  if (e.target.tagName === "LI") {
    const project = e.target.textContent;
    const year = yearSelect.value;
    const box = boxSelect.value;

    if (!boxAssignments[box]) boxAssignments[box] = [];

    boxAssignments[box].push(project);
    updateProjectList();
    updateBoxContent();
  }
});

boxContent.addEventListener("click", e => {
  if (e.target.tagName === "LI") {
    const project = e.target.textContent;
    const year = yearSelect.value;
    const box = boxSelect.value;

    if (!boxAssignments[box]) boxAssignments[box] = [];

    // 移除該標案
    boxAssignments[box] = boxAssignments[box].filter(p => p !== project);

    updateProjectList();
    updateBoxContent();
  }
});

addBoxBtn.addEventListener("click", () => {
  const year = yearSelect.value;
  const boxes = Object.keys(boxAssignments).filter(b => b.startsWith(year + "-"));
  let maxNum = 0;
  boxes.forEach(b => {
    const n = parseInt(b.split("-")[1]);
    if (n > maxNum) maxNum = n;
  });
  const newBox = `${year}-${maxNum + 1}`;
  boxAssignments[newBox] = [];
  refreshBoxSelect();
  boxSelect.value = newBox;
  updateBoxContent();
});

delBoxBtn.addEventListener("click", () => {
  const year = yearSelect.value;
  const boxes = Object.keys(boxAssignments)
    .filter(b => b.startsWith(year + "-"))
    .sort((a,b) => parseInt(b.split("-")[1]) - parseInt(a.split("-")[1]));

  if (boxes.length === 0) {
    alert("沒有可刪除的箱號");
    return;
  }

  const delBox = boxes[0];
  // 移回標案到年度標案
  if (boxAssignments[delBox] && boxAssignments[delBox].length > 0) {
    boxAssignments[delBox].forEach(p => {
      // 年度標案已存在，不重複加入
      if (!yearData[year].includes(p)) yearData[year].push(p);
    });
  }
  delete boxAssignments[delBox];

  refreshBoxSelect();
  updateProjectList();
  updateBoxContent();
  boxDetailsDiv.textContent = "";
});

exportBtn.addEventListener("click", () => {
  let csv = "箱號,標案名稱\n";
  const boxes = Object.keys(boxAssignments).sort((a,b) => {
    const [yA, nA] = a.split("-");
    const [yB, nB] = b.split("-");
    if (yA !== yB) return yA.localeCompare(yB);
    return parseInt(nA) - parseInt(nB);
  });

  boxes.forEach(box => {
    const projs = boxAssignments[box];
    if (projs.length === 0) {
      csv += `"${box}",\n`;
    } else {
      projs.forEach(p => {
        csv += `"${box}","${p}"\n`;
      });
    }
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "分箱結果.csv";
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

showBoxDetailsBtn.addEventListener("click", () => {
  const box = boxSelect.value;
  if (!box) {
    boxDetailsDiv.textContent = "請先選擇箱號";
    return;
  }
  const projs = boxAssignments[box];
  if (!projs || projs.length === 0) {
    boxDetailsDiv.textContent = `箱號 ${box} 目前沒有標案內容`;
    return;
  }
  let text = `箱號 ${box} 標案內容:\n\n`;
  projs.forEach((p,i) => {
    text += `${i+1}. ${p}\n`;
  });
  boxDetailsDiv.textContent = text;
});

printPreviewBtn.addEventListener("click", () => {
  const box = boxSelect.value;
  if (!box) {
    alert("請先選擇箱號");
    return;
  }
  printBoxes([box]);
});

printAllBtn.addEventListener("click", () => {
  const boxes = Object.keys(boxAssignments).sort((a,b) => {
    const [yA, nA] = a.split("-");
    const [yB, nB] = b.split("-");
    if (yA !== yB) return yA.localeCompare(yB);
    return parseInt(nA) - parseInt(nB);
  });
  printBoxes(boxes);
});

function printBoxes(boxArray) {
  const today = new Date().toISOString().slice(0, 10);
  let html = `
  <html><head><meta charset="UTF-8" />
  <title>列印預覽</title>
  <style>
    @page { size: A4 landscape; margin: 20mm 15mm 25mm 15mm; }
    body { font-family: "Microsoft JhengHei", sans-serif; color: #222; margin: 0; padding: 0 15mm; -webkit-print-color-adjust: exact; }
    .page { page-break-after: always; padding-bottom: 20px; border-bottom: 2px solid #bbb; box-sizing: border-box; }
    h2 { text-align: center; margin: 8px 0; }
    ul { list-style:none; padding-left: 0; margin-top: 5px; }
    li { font-weight: bold; font-size: 18px; line-height: 1.5; margin-bottom: 3px; }
  </style>
  </head><body>
  <h1 style="text-align:center; margin-bottom:30px;">分箱標案列印 - ${today}</h1>
  `;

  boxArray.forEach(box => {
    html += `<div class="page"><h2>箱號 ${box}</h2><ul>`;
    const projects = boxAssignments[box] || [];
    if (projects.length === 0) {
      html += `<li>無標案</li>`;
    } else {
      projects.forEach(p => {
        html += `<li>${p}</li>`;
      });
    }
    html += "</ul></div>";
  });

  html += `</body></html>`;

  const doc = printFrame.contentDocument || printFrame.contentWindow.document;
  doc.open();
  doc.write(html);
  doc.close();
  printFrame.contentWindow.focus();
  printFrame.contentWindow.print();
}

saveToSheetBtn.addEventListener("click", async () => {
  try {
    let saveData = [];
    Object.keys(boxAssignments).forEach(box => {
      const projs = boxAssignments[box];
      projs.forEach(p => {
        saveData.push({ box, project: p });
      });
    });

    if (saveData.length === 0) {
      alert("沒有分箱結果，無法存檔");
      return;
    }

    const res = await fetch(webAppURL, {
      method: "POST",
      body: JSON.stringify(saveData),
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) {
      alert("存檔失敗");
      return;
    }

    const text = await res.text();
    if (text === "OK") {
      alert("存檔成功！");
    } else {
      alert("存檔失敗：" + text);
    }
  } catch (err) {
    alert("存檔錯誤：" + err);
  }
});

// 頁面初始載入
loadSheetData();

</script>

</body>
</html>

