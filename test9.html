<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¾ Google Sheets è¼‰å…¥æ¨™æ¡ˆï¼‹æ‹–æ›³åˆ†é¡</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
select, button { padding: 6px 10px; margin-right: 6px; }
.container { display: flex; gap: 20px; margin-top: 15px; }
.panel, .group { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.panel { width: 260px; }
.groups { flex: 1; display: flex; gap: 15px; flex-wrap: wrap; }
.group { width: 260px; min-height: 180px; border: 2px solid transparent; cursor: pointer; }
.group.selected { border-color: #007acc; background: #eef6ff; }
.group-header { display: flex; justify-content: space-between; align-items: center; gap:5px; flex-wrap: wrap; }
.group-header h3 { margin:0; cursor:pointer; flex:1; }
.drop-zone { border: 2px dashed #bbb; padding: 10px; min-height: 80px; }
.item { background: #e3f0ff; padding: 6px; border-radius: 4px; margin-bottom: 6px; cursor: grab; display: flex; justify-content: space-between; align-items: center; }
.item button { font-size: 12px; padding: 2px 6px; }
</style>
</head>
<body>

<h1>å¾ Google Sheets è¼‰å…¥æ¨™æ¡ˆï¼‹åˆ†é¡ç®¡ç†</h1>

<select id="yearSelect" onchange="switchYear()"></select>
<button onclick="addGroup()">â• æ–°å¢åˆ†é¡</button>
<button onclick="saveData()">ğŸ’¾ å„²å­˜ data.json</button>
<button onclick="exportJSON()">ğŸ“¤ åŒ¯å‡º JSON</button>

<div class="container">
  <div class="panel">
    <h3>æœªåˆ†é¡æ¨™æ¡ˆ</h3>
    <div class="drop-zone" data-target="unassigned" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
  </div>
  <div class="groups" id="groups"></div>
</div>

<script>
// Google Sheet è¨­å®š
const SPREADSHEET_ID = "13dmvWC0dvC_9O6lBbx_sDc_NG68Sp_wwX3_-MG_LPvc";
const SHEET_NAME = "æ¨™æ¡ˆè³‡æ–™";

let state = {};
let currentYear = null;
let selectedGroupIndex = null;

// è¼‰å…¥ data.json + Google Sheets
async function loadInitialData() {
  try {
    const r = await fetch("data.json");
    const initialData = await r.json();
    state = initialData;
  } catch(e) {
    console.warn("ç„¡æ³•è¼‰å…¥ data.jsonï¼Œåˆå§‹åŒ–ç‚ºç©º", e);
    state = {};
  }

  try {
    const url = `https://opensheet.elk.sh/${SPREADSHEET_ID}/${SHEET_NAME}`;
    const r = await fetch(url);
    const rows = await r.json();

    rows.forEach(row => {
      Object.keys(row).forEach(key => {
        if (!key || !row[key]) return;
        if (!state[key]) state[key] = { unassigned: [], groups: [] };
        const allAssigned = state[key].groups.flatMap(g => g.items).concat(state[key].unassigned);
        if (!allAssigned.includes(row[key])) state[key].unassigned.push(row[key]);
      });
    });
  } catch(e) {
    console.warn("ç„¡æ³•æŠ“å– Google Sheet è³‡æ–™", e);
  }
}

function init() {
  loadInitialData().then(() => {
    const sel = document.getElementById("yearSelect");
    sel.innerHTML = "";
    Object.keys(state).forEach(y => sel.innerHTML += `<option value="${y}">${y} å¹´åº¦</option>`);
    currentYear = sel.value;
    render();
  });
}

function switchYear() { currentYear = document.getElementById("yearSelect").value; selectedGroupIndex = null; render(); }

function addGroup() { 
  const y = state[currentYear]; 
  y.groups.push({ name: `${currentYear}å¹´åº¦-${y.groups.length+1}`, items: [] }); 
  render(); 
}

function deleteGroup(i) {
  const y = state[currentYear];
  if (!confirm(`ç¢ºå®šåˆªé™¤ ${y.groups[i].name}ï¼Ÿ`)) return;
  y.unassigned.push(...y.groups[i].items);
  y.groups.splice(i,1);
  selectedGroupIndex = null;
  render();
}

function createItem(name, fromGroup=false) {
  const d = document.createElement("div"); 
  d.className="item"; 
  d.textContent=name;
  d.draggable=true; 
  d.ondragstart=e=>e.dataTransfer.setData("text",name);
  const btn = document.createElement("button");
  btn.textContent = fromGroup ? "é€€å›" : "åŠ å…¥";
  btn.onclick = (e) => {
    e.stopPropagation();
    if (fromGroup) moveItem(name,"unassigned");
    else {
      if (selectedGroupIndex===null) alert("è«‹å…ˆé¸åˆ†é¡");
      else moveItem(name, selectedGroupIndex);
    }
  };
  d.appendChild(btn);
  return d;
}

function allowDrop(ev) { ev.preventDefault(); }

function drop(ev) { 
  ev.preventDefault(); 
  let target = ev.target;
  while(target && !target.dataset.group && target.dataset.target!=="unassigned") target = target.parentElement;
  moveItem(ev.dataTransfer.getData("text"), target?.dataset.group ?? "unassigned");
}

function moveItem(name, gi) {
  const y = state[currentYear];
  y.unassigned = y.unassigned.filter(n=>n!==name);
  y.groups.forEach(g=>g.items=g.items.filter(n=>n!==name));
  if (gi==="unassigned"||gi===undefined) y.unassigned.push(name);
  else y.groups[gi].items.push(name);
  render();
}

function render() {
  const unassigned = document.querySelector(".panel .drop-zone"), groupsDiv=document.getElementById("groups");
  unassigned.innerHTML=""; 
  groupsDiv.innerHTML="";
  state[currentYear].unassigned.forEach(n => unassigned.appendChild(createItem(n,false)));
  state[currentYear].groups.forEach((g,i)=>{
    const div=document.createElement("div"); 
    div.className="group"+(selectedGroupIndex===i?" selected":"");
    
    div.innerHTML=`
      <div class="group-header">
        <h3>${g.name}</h3>
        <div>
          <button onclick="event.stopPropagation(); returnAll(${i})">â¬…ï¸ å…¨éƒ¨é€€å›</button>
          <button onclick="event.stopPropagation(); deleteGroup(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="drop-zone" data-group="${i}" ondragover="allowDrop(event)" ondrop="drop(event)"></div>`;
    
    // å…è¨±é»æ“Šæ¨™é¡Œç·¨è¼¯åç¨±
    const header = div.querySelector("h3");
    header.onclick = (e) => {
      e.stopPropagation();
      const newName = prompt("è¼¸å…¥æ–°çš„ç¾¤çµ„åç¨±", g.name);
      if(newName) { g.name = newName; render(); }
    }

    g.items.forEach(n=>div.querySelector(".drop-zone").appendChild(createItem(n,true)));
    div.onclick=()=>{ selectedGroupIndex=i; render(); };
    groupsDiv.appendChild(div);
  });
}

// å…¨éƒ¨é€€å›æœªåˆ†é¡
function returnAll(i) {
  const y = state[currentYear];
  y.unassigned.push(...y.groups[i].items);
  y.groups[i].items = [];
  render();
}

function saveData() { 
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data.json";
  a.click();
  alert("å·²ä¸‹è¼‰ data.jsonï¼Œå¯ç”¨æ–¼è¦†è“‹åŸæª”æ¡ˆ");
}

function exportJSON() {
  const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const a=document.createElement("a"); 
  a.href=URL.createObjectURL(blob);
  a.download="å¹´åº¦æ¨™æ¡ˆåˆ†é¡.json"; 
  a.click();
}

init();
</script>

</body>
</html>
