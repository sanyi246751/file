<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ¨™æ¡ˆåˆ†é¡ç®¡ç†</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
select, button { padding: 6px 10px; margin-right: 6px; }
.container { display: flex; gap: 20px; margin-top: 15px; }
.panel, .group { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.panel { width: 260px; }
.groups { flex: 1; display: flex; gap: 15px; flex-wrap: wrap; }
.group { width: 260px; min-height: 180px; border: 2px solid transparent; cursor: pointer; }
.group.selected { border-color: #007acc; background: #eef6ff; }
.group-header { display: flex; justify-content: space-between; align-items: center; }
.group-header h3 { cursor: pointer; flex:1; margin:0; }
.drop-zone { border: 2px dashed #bbb; padding: 10px; min-height: 80px; }
.item { background: #e3f0ff; padding: 6px; border-radius: 4px; margin-bottom: 6px; cursor: grab; display: flex; justify-content: space-between; align-items: center; }
.item button { font-size: 12px; padding: 2px 6px; }
input.group-name { width: 80%; font-size: 14px; }
</style>
</head>
<body>

<h1>æ¨™æ¡ˆåˆ†é¡ç®¡ç†ï¼ˆå¯å„²å­˜è‡³ Google Sheetï¼‰</h1>

<select id="yearSelect" onchange="switchYear()"></select>
<button onclick="addGroup()">â• æ–°å¢åˆ†é¡</button>
<button onclick="saveData()">ğŸ’¾ å„²å­˜åˆ° Sheet</button>
<button onclick="exportJSON()">ğŸ“¤ åŒ¯å‡º JSON</button>

<div class="container">
  <div class="panel">
    <h3>æœªåˆ†é¡æ¨™æ¡ˆ</h3>
    <div class="drop-zone" data-group="unassigned" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
  </div>
  <div class="groups" id="groups"></div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxBOcsSHuSzZ44Ieli9JBrXXSWxOHaFMeE3yNMLRqgMZh7NbrghKguU4N_JBxyHWsrWKg/exec";

let state = {};
let currentYear = null;
let selectedGroupIndex = null;

// è®€å–æ¨™æ¡ˆè³‡æ–™
async function loadSheetData() {
  try {
    const res = await fetch(GAS_URL+"?action=get");
    const rows = await res.json();
    rows.forEach(row=>{
      const year = row["å¹´åº¦"];
      const name = row["æ¨™æ¡ˆåç¨±"];
      if(!year||!name) return;
      if(!state[year]) state[year]={unassigned:[],groups:[]};
      state[year].unassigned.push(name);
    });
  } catch(err) {
    alert("ç„¡æ³•è®€å–æ¨™æ¡ˆè³‡æ–™ï¼Œè«‹ç¢ºèª GAS URL å¯å­˜å–");
  }
}

// åˆå§‹åŒ–
async function init() {
  await loadSheetData();
  const sel = document.getElementById("yearSelect");
  sel.innerHTML="";
  Object.keys(state).forEach(y=>sel.innerHTML+=`<option value="${y}">${y} å¹´åº¦</option>`);
  currentYear = sel.value;
  render();
}

function switchYear(){ currentYear=document.getElementById("yearSelect").value; selectedGroupIndex=null; render(); }
function addGroup(){ state[currentYear].groups.push({name:`${currentYear}å¹´åº¦-${state[currentYear].groups.length+1}`,items:[]}); render(); }
function deleteGroup(i){
  if(!confirm(`ç¢ºå®šåˆªé™¤ ${state[currentYear].groups[i].name}ï¼Ÿ`)) return;
  state[currentYear].unassigned.push(...state[currentYear].groups[i].items);
  state[currentYear].groups.splice(i,1);
  selectedGroupIndex=null;
  render();
}
function createItem(name,fromGroup=false){
  const d=document.createElement("div");
  d.className="item";
  d.textContent=name;
  d.draggable=true;
  d.ondragstart=e=>e.dataTransfer.setData("text",name);
  const btn=document.createElement("button");
  btn.textContent=fromGroup?"é€€å›æœªåˆ†é¡":"åŠ å…¥é¸ä¸­åˆ†é¡";
  btn.onclick=()=>{fromGroup?moveItem(name,"unassigned"):(selectedGroupIndex===null?alert("è«‹å…ˆé¸åˆ†é¡"):moveItem(name,selectedGroupIndex));};
  d.appendChild(btn);
  return d;
}
function allowDrop(ev){ ev.preventDefault(); }
function drop(ev){
  ev.preventDefault();
  const dz = ev.target.closest(".drop-zone");
  if(!dz) return;
  moveItem(ev.dataTransfer.getData("text"),dz.dataset.group);
}
function moveItem(name,gi){
  const y = state[currentYear];
  y.unassigned=y.unassigned.filter(n=>n!==name);
  y.groups.forEach(g=>g.items=g.items.filter(n=>n!==name));
  if(gi==="unassigned"||gi===undefined) y.unassigned.push(name);
  else y.groups[gi].items.push(name);
  render();
}
function render(){
  const unassigned=document.querySelector(".panel .drop-zone"),groupsDiv=document.getElementById("groups");
  unassigned.innerHTML="";
  groupsDiv.innerHTML="";
  state[currentYear].unassigned.forEach(n=>unassigned.appendChild(createItem(n,false)));
  state[currentYear].groups.forEach((g,i)=>{
    const div=document.createElement("div");
    div.className="group"+(selectedGroupIndex===i?" selected":"");
    div.onclick=()=>{selectedGroupIndex=i; render();};

    // å¯ç·¨è¼¯åˆ†é¡åç¨±
    div.innerHTML=`
      <div class="group-header">
        <input class="group-name" value="${g.name}" onchange="state[currentYear].groups[${i}].name=this.value"/>
        <button onclick="event.stopPropagation();deleteGroup(${i})">ğŸ—‘ï¸</button>
      </div>
      <div class="drop-zone" data-group="${i}" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
    `;
    g.items.forEach(n=>div.querySelector(".drop-zone").appendChild(createItem(n,true)));
    groupsDiv.appendChild(div);
  });
}

// å„²å­˜åˆ° Google Sheet
function saveData(){
  fetch(GAS_URL,{
    method:"POST",
    body:JSON.stringify(state),
    headers:{"Content-Type":"application/json"}
  })
  .then(res=>res.json())
  .then(res=>res.status==="success"?alert("å·²å„²å­˜è‡³ Google Sheet"):alert("å„²å­˜å¤±æ•—:"+res.message))
  .catch(err=>alert("å„²å­˜å¤±æ•—:"+err));
}

// åŒ¯å‡º JSON
function exportJSON(){
  const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="å¹´åº¦æ¨™æ¡ˆåˆ†é¡.json";
  a.click();
}

init();
</script>

</body>
</html>
