<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>標案分箱工具</title>
    <style>
        /* == General Styles == */
        body { font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif; padding: 20px; max-width: 1200px; margin: auto; background-color: #f4f7f9; color: #333; line-height: 1.6; }
        h2 { text-align: center; color: #005a9e; margin-bottom: 25px; font-size: 2.2rem; font-weight: 700; }
        select, button { margin: 5px; padding: 10px 18px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        select { background-color: #fff; border-color: #007BFF; appearance: none; -webkit-appearance: none; }
        button { background-color: #fff; color: #007BFF; border-color: #007BFF; font-weight: 600; }
        button:hover { background-color: #007BFF; color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2); }

        /* == Top Controls == */
        .top-controls { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        @media (min-width: 768px) {
            .top-controls { flex-direction: row; align-items: flex-start; justify-content: space-between; }
            .box-control-group { max-width: 500px; }
        }
        .label-group { display: flex; flex-direction: column; flex-grow: 1; }
        .label-group > label { font-weight: 700; margin-bottom: 8px; color: #005a9e; font-size: 1.1rem; }
        .box-control-group { flex-grow: 2; }
        #boxButtons { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
        #boxButtons button { padding: 8px 12px; border-radius: 5px; font-weight: 600; font-size: 0.95rem; }
        #boxButtons button.selected { background: #007BFF; color: white; transform: scale(1.05); box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3); }
        #boxButtons button:hover:not(.selected) { background: #e6f2ff; }
        #boxActionButtons { display: flex; gap: 10px; margin-top: 15px; }
        #boxActionButtons button { background: #fff; color: #007BFF; border-color: #007BFF; padding: 8px 15px; border-radius: 5px; font-weight: 600; }
        #boxActionButtons button:hover { background: #007BFF; color: white; }

        /* == Status Message == */
        #addDelStatus { min-height: 24px; margin-top: 15px; padding-left: 5px; font-size: 1rem; font-weight: 600; display: flex; align-items: center; }
        .status-loading { color: #007BFF; }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #007BFF; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* == Main Containers == */
        .container {
            display: flex;
            flex-direction: row;
            gap: 30px;
            margin-top: 20px;
        }
        @media (max-width: 767px) {
            .container { flex-direction: column; }
        }
        .box-panel { 
            flex: 1;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }
        h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 15px; color: #005a9e; font-size: 1.5rem; font-weight: 700; }
        ul { list-style: none; padding-left: 0; margin: 0; max-height: 600px; overflow-y: auto; }
        li { padding: 12px 15px; margin: 8px 0; border-radius: 8px; cursor: pointer; background-color: #f9f9f9; border-left: 5px solid #007BFF; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        li:hover { background: #eef7ff; transform: translateX(5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        li:active { background: #d9eaff; }
        li.dragging { opacity: 0.5; border-left-color: #dc3545; }

        /* == Function Buttons == */
        #functionButtons { margin-top: 30px; display: flex; flex-wrap: wrap; gap: 15px; }
        #functionButtons button { padding: 12px 20px; border-radius: 8px; border: 1px solid #007BFF; background: white; color: #007BFF; font-weight: 600; font-size: 1rem; }
        #functionButtons button:hover { background: #007BFF; color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2); }
        #importCsvBtn { background-color: #28a745; color: white; border-color: #28a745; }
        #importCsvBtn:hover { background-color: #218838; }

        /* == Print Styles (Optimized) == */
        @media print {
            body { font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif; background: #fff; color: #000; font-size: 12pt; }
            @page { size: A4 landscape; margin: 20mm 15mm 25mm 15mm; }
            .page { page-break-after: always; padding-bottom: 20px; border-bottom: 2px solid #bbb; box-sizing: border-box; position: relative; }
            h1 { font-size: 24pt; font-weight: 900; text-align: center; margin: 0; padding-bottom: 4px; border-bottom: 2px solid #005a9e; color: #005a9e; letter-spacing: 1.5px; }
            .date { font-size: 14pt; color: #555; text-align: center; margin: 8px 0 16px 0; font-weight: 600; }
            /* 箱號字體已調整至 23pt */
            h3 { font-size: 23pt; font-weight: 700; color: #003f72; margin-bottom: 25px; letter-spacing: 1.5px; }
            /* 標案字體已調整至 22pt */
            ul { list-style-type: disc; padding-left: 50px; font-size: 22pt; line-height: 1.3; margin-top: 0; margin-bottom: 30px; word-break: break-word; }
            ul li { margin-bottom: 12px; }
            p.no-projects { font-size: 20pt; font-style: italic; color: #999; margin-bottom: 50px; text-align: center; }
            .top-controls, .container, #functionButtons { display: none; }
        }
    </style>
</head>
<body>

<h2>標案分箱工具</h2>

<div class="top-controls">
    <div class="label-group">
        <label for="yearSelect">選擇年度：</label>
        <select id="yearSelect"></select>
    </div>
    
    <div class="box-control-group">
        <div class="label-group">
            <label>選擇箱號：</label>
            <div id="boxButtons"></div>
        </div>
        <div id="boxActionButtons">
            <button id="addBoxBtn">新增箱號</button>
            <button id="delBoxBtn">刪除箱號</button>
        </div>
    </div>
</div>

<div id="addDelStatus"></div>

<div class="container">
    <div class="box-panel">
        <h3>年度標案名稱</h3>
        <ul id="projectList"></ul>
    </div>

    <div class="box-panel">
        <h3>箱號內容</h3>
        <ul id="boxContent"></ul>
    </div>
</div>

<div id="functionButtons">
    <button id="saveBtn">存檔分箱結果</button>
    <button id="loadBtn">讀取分箱結果</button>
    <button id="exportBtn">匯出分箱結果 CSV</button>
    <button id="importCsvBtn">匯入分箱結果 CSV</button>
    <button id="printPreviewBtn">列印預覽</button>
    <button id="printAllBtn">全部列印</button>
</div>
<input type="file" id="importCsvFile" accept=".csv" style="display:none;" />

<iframe id="printFrame" style="display:none;"></iframe>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw63c4akixbo2-yIRwgNGpOHjxSna_jg298B-n6ypNH3Nmc1xONQXc820Emsa5H0mto_Q/exec';

        const DOM = {
            yearSelect: document.getElementById("yearSelect"),
            boxButtonsDiv: document.getElementById("boxButtons"),
            projectList: document.getElementById("projectList"),
            boxContent: document.getElementById("boxContent"),
            addBoxBtn: document.getElementById("addBoxBtn"),
            delBoxBtn: document.getElementById("delBoxBtn"),
            saveBtn: document.getElementById("saveBtn"),
            loadBtn: document.getElementById("loadBtn"),
            exportBtn: document.getElementById("exportBtn"),
            importCsvBtn: document.getElementById("importCsvBtn"),
            importCsvFile: document.getElementById("importCsvFile"),
            printPreviewBtn: document.getElementById("printPreviewBtn"),
            printAllBtn: document.getElementById("printAllBtn"),
            addDelStatus: document.getElementById("addDelStatus"),
            printFrame: document.getElementById("printFrame")
        };

        let state = {
            yearData: {},
            boxAssignments: {},
            selectedBox: null
        };

        // API 服務，處理與 Google Apps Script 的通訊
        const apiService = {
            jsonpFetch: function(action, params = {}) {
                return new Promise((resolve, reject) => {
                    const callbackName = 'cb' + Math.floor(Math.random() * 1000000);
                    window[callbackName] = (response) => {
                        try { document.body.removeChild(script); } catch(e){/*ignore*/}
                        delete window[callbackName];
                        if(response.status === 'success') {
                            resolve(response.data || response);
                        } else {
                            reject(new Error(response.message || 'API 錯誤'));
                        }
                    };
                    params.action = action;
                    params.callback = callbackName;
                    const queryString = Object.entries(params).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
                    const script = document.createElement('script');
                    script.src = `${GAS_URL}?${queryString}`;
                    script.onerror = () => {
                        try { document.body.removeChild(script); } catch(e){/*ignore*/}
                        delete window[callbackName];
                        reject(new Error('JSONP 載入失敗或網路異常'));
                    };
                    document.body.appendChild(script);
                });
            }
        };

        // UI 服務，處理介面顯示與更新
        const uiService = {
            showStatus: function(message, type = 'info', isLoading = false) {
                DOM.addDelStatus.className = '';
                DOM.addDelStatus.textContent = '';
                if(isLoading) {
                    DOM.addDelStatus.classList.add('status-loading');
                    const spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    DOM.addDelStatus.appendChild(spinner);
                }
                DOM.addDelStatus.appendChild(document.createTextNode(message));
                if(type === 'success') DOM.addDelStatus.classList.add('status-success');
                if(type === 'error') DOM.addDelStatus.classList.add('status-error');
            },
            populateYearSelect: function() {
                DOM.yearSelect.innerHTML = '';
                const years = Object.keys(state.yearData);
                if(years.length === 0) return;
                years.sort((a,b) => parseInt(b) - parseInt(a));
                years.forEach(year => {
                    const opt = document.createElement('option');
                    opt.value = year;
                    opt.textContent = year;
                    DOM.yearSelect.appendChild(opt);
                });
                DOM.yearSelect.value = years[0];
            },
            refreshBoxSelect: function() {
                const selectedYear = DOM.yearSelect.value;
                DOM.boxButtonsDiv.innerHTML = '';
                const boxes = Object.keys(state.boxAssignments).filter(b => b.startsWith(selectedYear));
                boxes.sort((a,b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
                boxes.forEach(boxId => {
                    const btn = document.createElement('button');
                    btn.textContent = boxId;
                    btn.classList.toggle('selected', boxId === state.selectedBox);
                    btn.addEventListener('click', () => {
                        state.selectedBox = boxId;
                        uiService.refreshBoxSelect();
                        uiService.updateBoxContent();
                    });
                    DOM.boxButtonsDiv.appendChild(btn);
                });
                if (!boxes.includes(state.selectedBox)) {
                    state.selectedBox = boxes[0] || null;
                }
                uiService.updateBoxButtonsHighlight();
                uiService.updateBoxContent();
            },
            updateBoxButtonsHighlight: function() {
                [...DOM.boxButtonsDiv.children].forEach(btn => {
                    btn.classList.toggle('selected', btn.textContent === state.selectedBox);
                });
            },
            updateProjectList: function() {
                const year = DOM.yearSelect.value;
                const projects = state.yearData[year] || [];
                DOM.projectList.innerHTML = '';
                projects.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = p;
                    li.setAttribute('draggable', true);
                    DOM.projectList.appendChild(li);
                });
            },
            updateBoxContent: function() {
                if (!state.selectedBox) {
                    DOM.boxContent.innerHTML = '';
                    return;
                }
                const projects = state.boxAssignments[state.selectedBox] || [];
                DOM.boxContent.innerHTML = '';
                projects.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = p;
                    li.setAttribute('draggable', true);
                    DOM.boxContent.appendChild(li);
                });
            },
            openPrintPreview: function(printAll = false) {
                const year = DOM.yearSelect.value;
                if (!year) return alert('請先選擇年度');

                let targetBoxes;
                if (printAll) {
                    const boxes = Object.keys(state.boxAssignments).filter(b => b.startsWith(year));
                    if (boxes.length === 0) return alert('目前無分箱資料可列印');
                    targetBoxes = boxes.sort((a,b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
                } else {
                    if (!state.selectedBox) return alert('請先選擇一個箱號');
                    targetBoxes = [state.selectedBox];
                }

                let html = `<html><head><title>分箱結果列印預覽</title><style>
                    @page { size: A4 landscape; margin: 20mm 15mm 25mm 15mm; }
                    body { font-family: "Microsoft JhengHei", sans-serif; color: #222; margin: 0; padding: 0 15mm; -webkit-print-color-adjust: exact; }
                    .page { page-break-after: always; padding-bottom: 20px; border-bottom: 2px solid #bbb; box-sizing: border-box; position: relative; }
                    h1 { font-size: 24pt; font-weight: 900; text-align: center; margin: 0; padding-bottom: 4px; border-bottom: 2px solid #005a9e; color: #005a9e; letter-spacing: 1.5px; }
                    .date { font-size: 14pt; color: #555; text-align: center; margin: 8px 0 16px 0; font-weight: 600; }
                    h3 { font-size: 23pt; font-weight: 700; color: #003f72; margin-bottom: 25px; letter-spacing: 1.5px; }
                    ul { list-style-type: disc; padding-left: 50px; font-size: 22pt; line-height: 1.3; margin-top: 0; margin-bottom: 30px; word-break: break-word; }
                    ul li { margin-bottom: 12px; }
                    p.no-projects { font-size: 20pt; font-style: italic; color: #999; margin-bottom: 50px; text-align: center; }
                    .top-controls, .container, #functionButtons { display: none; }
                </style></head><body>`;
                html += `<h1>苗栗縣三義鄉公所</h1>`;
                html += `<div class="date">列印日期：${new Date().getFullYear() - 1911}年${(new Date().getMonth() + 1)}月${new Date().getDate()}日</div>`;
                
                targetBoxes.forEach(box => {
                    const projects = state.boxAssignments[box] || [];
                    html += `<div class="page"><h3>箱號：${box}</h3>`;
                    if (projects.length > 0) {
                        html += `<ul>${projects.map(proj => `<li>${proj}</li>`).join('')}</ul>`;
                    } else {
                        html += `<p class="no-projects">（此箱無標案資料）</p>`;
                    }
                    html += `</div>`;
                });
                html += `</body></html>`;
                
                const doc = DOM.printFrame.contentWindow.document;
                doc.open();
                doc.write(html);
                doc.close();
                DOM.printFrame.contentWindow.focus();
                DOM.printFrame.contentWindow.print();
            }
        };

        // 事件處理服務，處理所有使用者互動
        const eventService = {
            moveProjectToBox: function(project) {
                const year = DOM.yearSelect.value;
                const box = state.selectedBox;
                if(!box) return uiService.showStatus('請先選擇箱號', 'error');
                state.yearData[year] = state.yearData[year].filter(p => p !== project);
                if(!state.boxAssignments[box]) state.boxAssignments[box] = [];
                state.boxAssignments[box].push(project);
                uiService.updateProjectList();
                uiService.updateBoxContent();
            },
            moveProjectToYear: function(project) {
                const year = DOM.yearSelect.value;
                const box = state.selectedBox;
                if(!box) return uiService.showStatus('請先選擇箱號', 'error');
                state.boxAssignments[box] = state.boxAssignments[box].filter(p => p !== project);
                if(!state.yearData[year]) state.yearData[year] = [];
                state.yearData[year].push(project);
                uiService.updateProjectList();
                uiService.updateBoxContent();
            },
            handleLoadYear: async function() {
                uiService.showStatus('讀取年度標案中...', 'info', true);
                try {
                    state.yearData = await apiService.jsonpFetch('loadData');
                    uiService.populateYearSelect();
                    await eventService.handleLoadAssignments();
                } catch(e) {
                    uiService.showStatus('載入年度資料失敗: ' + e.message, 'error');
                } finally {
                    uiService.showStatus(`載入完成`, 'success');
                }
            },
            handleLoadAssignments: async function() {
                const year = DOM.yearSelect.value;
                if(!year) return;
                uiService.showStatus(`讀取年度 ${year} 分箱結果中...`, 'info', true);
                try {
                    const data = await apiService.jsonpFetch('loadAssignments', { year });
                    state.boxAssignments = data || {};
                    if(state.yearData[year]) {
                        let assignedProjects = [];
                        Object.entries(state.boxAssignments).forEach(([box, projects]) => {
                            if(box.startsWith(year)) assignedProjects = assignedProjects.concat(projects);
                        });
                        state.yearData[year] = state.yearData[year].filter(p => !assignedProjects.includes(p));
                    }
                    eventService.initializeBoxes(year);
                    uiService.refreshBoxSelect();
                    uiService.updateBoxContent();
                    uiService.updateProjectList();
                    uiService.showStatus(`讀取年度 ${year} 分箱結果完成（${new Date().toLocaleString()}）`, 'success');
                } catch(e) {
                    uiService.showStatus('讀取失敗: ' + e.message, 'error');
                }
            },
            initializeBoxes: function(year) {
                const existingBoxes = Object.keys(state.boxAssignments).filter(b => b.startsWith(year));
                if(existingBoxes.length === 0) {
                    for(let i=1; i<=3; i++) {
                        state.boxAssignments[`${year}-${i}`] = [];
                    }
                }
                if(!state.selectedBox || !state.boxAssignments[state.selectedBox] || !state.selectedBox.startsWith(year)) {
                    state.selectedBox = Object.keys(state.boxAssignments).find(b => b.startsWith(year)) || null;
                }
            },
            handleSave: async function() {
                const year = DOM.yearSelect.value;
                if (!year) { uiService.showStatus('請先選擇年度', 'error'); return; }
                uiService.showStatus(`開始存檔年度 ${year} 的分箱結果...`, 'info', true);
                try {
                    const boxes = Object.keys(state.boxAssignments).filter(b => b.startsWith(year));
                    const savePromises = boxes.map(box => {
                        const projects = state.boxAssignments[box] || [];
                        return apiService.jsonpFetch('saveSingleBox', { box, projects: projects.join('|') });
                    });
                    await Promise.all(savePromises);
                    uiService.showStatus(`年度 ${year} 分箱結果存檔成功（${new Date().toLocaleString()}）`, 'success');
                } catch(error) {
                    uiService.showStatus(`存檔失敗: ${error.message}`, 'error');
                }
            },
            handleExport: function() {
                let csv = '箱號,標案名稱\n';
                Object.entries(state.boxAssignments)
                    .forEach(([box, projects]) => {
                        projects.forEach(proj => {
                            csv += `"${box}","${proj.replace(/"/g, '""')}"\n`;
                        });
                    });
                
                const bom = '\ufeff'; 
                const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                const now = new Date();
                const year = now.getFullYear() - 1911;
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const filename = `分箱結果-${year}${month}${day}-${hours}${minutes}${seconds}.csv`;
                
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                uiService.showStatus(`匯出檔案 ${filename} 完成`, 'success');
            },
            handleImport: async function(file) {
                if (!file) { uiService.showStatus('請選擇一個 CSV 檔案', 'error'); return; }
                uiService.showStatus(`正在匯入並清空舊資料...`, 'info', true);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.trim().split('\n').slice(1);
                    const newAssignments = {};
                    const allYearsAffected = new Set();
                    let errorFound = false;

                    for (const line of lines) {
                        const matches = line.match(/(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(?:,|$)/g);
                        if (!matches || matches.length < 2) {
                            uiService.showStatus('CSV 檔案格式有誤，請確保每行都包含箱號與標案名稱', 'error');
                            errorFound = true;
                            break;
                        }
                        const [box, project] = matches.map(s => s.replace(/",?$|^"/g, '').replace(/""/g, '"'));
                        
                        const yearMatch = box.match(/^\d+/);
                        if (!yearMatch) {
                            uiService.showStatus('CSV 檔案中箱號格式不正確，應為「年度-編號」', 'error');
                            errorFound = true;
                            break;
                        }
                        const year = yearMatch[0];
                        allYearsAffected.add(year);

                        if (!newAssignments[box]) {
                            newAssignments[box] = [];
                        }
                        newAssignments[box].push(project);
                    }
                    if (errorFound) return;

                    // 步驟 1: 清空受影響年度的所有舊箱號資料（線上）
                    uiService.showStatus(`正在清空線上 ${[...allYearsAffected].join(',')} 年度舊資料...`, 'info', true);
                    const yearsToDelete = Object.keys(state.boxAssignments).filter(b => allYearsAffected.has(b.split('-')[0]));
                    const clearPromises = yearsToDelete.map(box => {
                        return apiService.jsonpFetch('saveSingleBox', { box, projects: '' });
                    });

                    try {
                        await Promise.all(clearPromises);

                        // 步驟 2: 更新本地端資料
                        allYearsAffected.forEach(year => {
                            Object.keys(state.boxAssignments).filter(b => b.startsWith(year)).forEach(box => {
                                delete state.boxAssignments[box];
                            });
                        });
                        Object.assign(state.boxAssignments, newAssignments);

                        // 步驟 3: 將新資料同步到線上
                        uiService.showStatus(`正在將新資料同步至線上...`, 'info', true);
                        const savePromises = Object.entries(newAssignments).map(([box, projects]) => {
                            return apiService.jsonpFetch('saveSingleBox', { box, projects: projects.join('|') });
                        });
                        await Promise.all(savePromises);

                        // 步驟 4: 更新未分箱標案列表
                        for (const year of allYearsAffected) {
                            if (state.yearData[year]) {
                                const assignedProjects = Object.entries(state.boxAssignments)
                                    .filter(([box]) => box.startsWith(year))
                                    .flatMap(([, projects]) => projects);
                                state.yearData[year] = state.yearData[year].filter(p => !assignedProjects.includes(p));
                            }
                        }

                        // 最後更新 UI
                        uiService.refreshBoxSelect();
                        uiService.updateBoxContent();
                        uiService.updateProjectList();
                        uiService.showStatus('CSV 檔案匯入並線上更新成功！', 'success');

                    } catch(error) {
                        uiService.showStatus(`匯入失敗: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }
        };

        // 綁定事件監聽
        DOM.yearSelect.addEventListener('change', eventService.handleLoadAssignments);
        DOM.addBoxBtn.addEventListener('click', () => {
            const year = DOM.yearSelect.value;
            if(!year) return uiService.showStatus('請先選擇年度', 'error');
            const boxesOfYear = Object.keys(state.boxAssignments).filter(b => b.startsWith(year));
            const nextNum = boxesOfYear.length > 0 ? Math.max(...boxesOfYear.map(b => parseInt(b.split('-')[1]))) + 1 : 1;
            const newBox = `${year}-${nextNum}`;
            state.boxAssignments[newBox] = [];
            state.selectedBox = newBox;
            uiService.refreshBoxSelect();
            uiService.showStatus(`新增箱號 ${newBox} 完成`, 'success');
        });
        DOM.delBoxBtn.addEventListener('click', () => {
            const year = DOM.yearSelect.value;
            if (!year) return uiService.showStatus('請先選擇年度', 'error');
            const boxesOfYear = Object.keys(state.boxAssignments).filter(b => b.startsWith(year));
            if(boxesOfYear.length === 0) return uiService.showStatus('目前無可刪除的箱號', 'error');
            const maxBoxNum = Math.max(...boxesOfYear.map(b => parseInt(b.split('-')[1])));
            const delBox = `${year}-${maxBoxNum}`;
            if(state.boxAssignments[delBox]) {
                state.boxAssignments[delBox].forEach(p => {
                    if(!state.yearData[year]) state.yearData[year] = [];
                    state.yearData[year].push(p);
                });
                delete state.boxAssignments[delBox];
            }
            if(state.selectedBox === delBox) {
                const remainBoxes = Object.keys(state.boxAssignments).filter(b => b.startsWith(year));
                state.selectedBox = remainBoxes.length > 0 ? remainBoxes[0] : null;
            }
            uiService.refreshBoxSelect();
            uiService.updateProjectList();
            uiService.showStatus(`刪除箱號 ${delBox} 完成`, 'success');
        });
        DOM.saveBtn.addEventListener('click', eventService.handleSave);
        DOM.loadBtn.addEventListener('click', eventService.handleLoadAssignments);
        DOM.exportBtn.addEventListener('click', eventService.handleExport);
        DOM.importCsvBtn.addEventListener('click', () => DOM.importCsvFile.click());
        DOM.importCsvFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                eventService.handleImport(e.target.files[0]);
            }
        });
        DOM.printPreviewBtn.addEventListener('click', () => uiService.openPrintPreview(false));
        DOM.printAllBtn.addEventListener('click', () => uiService.openPrintPreview(true));

        // 拖曳功能實作
        let draggedItem = null;

        DOM.projectList.addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'LI') {
                draggedItem = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItem.textContent);
                setTimeout(() => draggedItem.classList.add('dragging'), 0);
            }
        });

        DOM.boxContent.addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'LI') {
                draggedItem = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItem.textContent);
                setTimeout(() => draggedItem.classList.add('dragging'), 0);
            }
        });

        DOM.projectList.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        DOM.boxContent.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        DOM.projectList.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedItem && draggedItem.parentElement.id === 'boxContent') {
                const project = e.dataTransfer.getData('text/plain');
                eventService.moveProjectToYear(project);
                draggedItem.classList.remove('dragging');
            }
        });

        DOM.boxContent.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedItem && draggedItem.parentElement.id === 'projectList') {
                const project = e.dataTransfer.getData('text/plain');
                eventService.moveProjectToBox(project);
                draggedItem.classList.remove('dragging');
            }
        });

        // 重置拖曳狀態
        document.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
        });
        
        // 點擊功能實作
        DOM.projectList.addEventListener('click', e => {
            if(e.target.tagName === 'LI') {
                eventService.moveProjectToBox(e.target.textContent);
            }
        });

        DOM.boxContent.addEventListener('click', e => {
            if(e.target.tagName === 'LI') {
                eventService.moveProjectToYear(e.target.textContent);
            }
        });

        // 啟動程式
        eventService.handleLoadYear();

    });
</script>

</body>
</html>