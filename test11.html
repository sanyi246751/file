<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ¨™æ¡ˆåˆ†é¡ç®¡ç†</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
select, button { padding: 6px 10px; margin-right: 6px; }
.container { display: flex; gap: 20px; margin-top: 15px; }
.panel, .group { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.panel { width: 260px; }
.groups { flex: 1; display: flex; gap: 15px; flex-wrap: wrap; }
.group { width: 260px; min-height: 180px; border: 2px solid transparent; cursor: pointer; }
.group.selected { border-color: #007acc; background: #eef6ff; }
.group-header { display: flex; justify-content: space-between; align-items: center; }
.drop-zone { border: 2px dashed #bbb; padding: 10px; min-height: 80px; }
.item { background: #e3f0ff; padding: 6px; border-radius: 4px; margin-bottom: 6px; cursor: grab; display: flex; justify-content: space-between; align-items: center; }
.item button { font-size: 12px; padding: 2px 6px; }
</style>
</head>
<body>

<h1>æ¨™æ¡ˆåˆ†é¡ç®¡ç†</h1>

<select id="yearSelect" onchange="switchYear()"></select>
<button onclick="addGroup()">â• æ–°å¢åˆ†é¡</button>
<button onclick="saveData()">ğŸ’¾ å„²å­˜</button>

<div class="container">
  <div class="panel">
    <h3>æœªåˆ†é¡æ¨™æ¡ˆ</h3>
    <div class="drop-zone" data-target="unassigned"
         ondragover="allowDrop(event)" ondrop="drop(event)"></div>
  </div>
  <div class="groups" id="groups"></div>
</div>

<script>
/* ====== è¨­å®š ====== */
const GAS_URL = 'https://script.google.com/macros/s/XXXXX/exec'; // â†æ›æˆä½ çš„

let state = {};
let currentYear = null;
let selectedGroupIndex = null;

/* ====== åˆå§‹åŒ– ====== */
async function init() {
  const r = await fetch(`${GAS_URL}?action=load`);
  state = await r.json();

  const sel = document.getElementById("yearSelect");
  sel.innerHTML = "";

  Object.keys(state).forEach(y => {
    sel.innerHTML += `<option value="${y}">${y} å¹´åº¦</option>`;
  });

  currentYear = sel.value;
  render();
}

/* ====== å¹´åº¦ ====== */
function switchYear() {
  currentYear = document.getElementById("yearSelect").value;
  selectedGroupIndex = null;
  render();
}

/* ====== ç¾¤çµ„ ====== */
function addGroup() {
  state[currentYear].groups.push({
    name: `${currentYear}å¹´åº¦-${state[currentYear].groups.length + 1}`,
    items: []
  });
  render();
}

function deleteGroup(i) {
  const y = state[currentYear];
  if (!confirm(`åˆªé™¤ ${y.groups[i].name}ï¼Ÿ`)) return;
  y.unassigned.push(...y.groups[i].items);
  y.groups.splice(i, 1);
  selectedGroupIndex = null;
  render();
}

/* ====== é …ç›® ====== */
function createItem(name, fromGroup) {
  const d = document.createElement("div");
  d.className = "item";
  d.textContent = name;
  d.draggable = true;
  d.ondragstart = e => e.dataTransfer.setData("text", name);

  const btn = document.createElement("button");
  btn.textContent = fromGroup ? "é€€å›" : "åŠ å…¥";
  btn.onclick = () => {
    if (!fromGroup && selectedGroupIndex === null) {
      alert("è«‹å…ˆé¸åˆ†é¡");
      return;
    }
    moveItem(name, fromGroup ? "unassigned" : selectedGroupIndex);
  };

  d.appendChild(btn);
  return d;
}

function allowDrop(e) { e.preventDefault(); }

function drop(e) {
  e.preventDefault();
  moveItem(e.dataTransfer.getData("text"), e.target.dataset.group);
}

function moveItem(name, gi) {
  const y = state[currentYear];
  y.unassigned = y.unassigned.filter(n => n !== name);
  y.groups.forEach(g => g.items = g.items.filter(n => n !== name));

  if (gi === "unassigned" || gi === undefined) y.unassigned.push(name);
  else y.groups[gi].items.push(name);

  render();
}

/* ====== ç•«é¢ ====== */
function render() {
  const unassigned = document.querySelector(".panel .drop-zone");
  const groupsDiv = document.getElementById("groups");

  unassigned.innerHTML = "";
  groupsDiv.innerHTML = "";

  state[currentYear].unassigned.forEach(n =>
    unassigned.appendChild(createItem(n, false))
  );

  state[currentYear].groups.forEach((g, i) => {
    const div = document.createElement("div");
    div.className = "group" + (selectedGroupIndex === i ? " selected" : "");
    div.onclick = () => { selectedGroupIndex = i; render(); };

    div.innerHTML = `
      <div class="group-header">
        <h3>${g.name}</h3>
        <button onclick="event.stopPropagation();deleteGroup(${i})">ğŸ—‘ï¸</button>
      </div>
      <div class="drop-zone" data-group="${i}"
           ondragover="allowDrop(event)" ondrop="drop(event)"></div>
    `;

    g.items.forEach(n =>
      div.querySelector(".drop-zone").appendChild(createItem(n, true))
    );

    groupsDiv.appendChild(div);
  });
}

/* ====== å„²å­˜ ====== */
async function saveData() {
  await fetch(`${GAS_URL}?action=save`, {
    method: 'POST',
    body: JSON.stringify(state)
  });
  alert('å·²å„²å­˜åˆ° Google Sheetsï¼ˆdata å·¥ä½œè¡¨ï¼‰');
}

init();
</script>
</body>
</html>
